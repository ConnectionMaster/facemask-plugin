matrix:
  fast_finish: true

image:
  - Visual Studio 2017

platform: x64

environment:
  SignTool: C:\Program Files (x86)\Windows Kits\10\bin\x64\signtool.exe
  StreamlabsPfxSecret:
    secure: iZlMSWnmH5FQDpa+/0SgXIyvCobkElj2y5lu94Uo8VnTWHTeTC1/bpVkzsLreENocomvDB5ywsa3+QdathRp8A==
  StreamlabsSecret:
    secure: hr+VpykbGiCI5I0ltiqH667wh/YQx2Fi5SBLfkOWHSg=

clone_folder: c:\projects\source

install:
  - git submodule update --init --recursive
  - ps: $env:SignedArtifact = "facemask-plugin-$(git describe --tags --abbrev=0)"
  - ps: $env:UnsignedArtifact = "facemask-plugin-$env:APPVEYOR_BUILD_NUMBER"

build_script:
- dir
- cmd: mkdir build
- cmd: cd build
- cmd: cmake c:\projects\source -G "Visual Studio 15 Win64"
- cmd: cmake --build . --config RelWithDebInfo

after_build:
- cmd: tar cvaf "%UnsignedArtifact%.tar.gz" "distribute" 

before_deploy:
- echo %CD%
- dir
- nuget install secure-file -ExcludeVersion
- ps: c:\projects\source\ci\win-signed-build.ps1
- tar cvaf "%SignedArtifact%.tar.gz" "distribute"
- ps: Push-AppveyorArtifact "$env:SignedArtifact.tar.gz"
- dir


artifacts:
  - path: $(UnsignedArtifact).tar.gz
    name: Unsigned Aritfact